<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Curando Coração Partido</title>
  <style>
    :root{
      --bg:#07040a;
      --card:#120817cc;
      --text:#f6eef8;
      --muted:#c9b6cf;
      --accent:#ff3b6b;
      --accent2:#8a2be2;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    body{
      background: radial-gradient(1200px 700px at 20% 10%, #2a0d3a 0%, transparent 60%),
                  radial-gradient(900px 600px at 80% 30%, #1b0b2e 0%, transparent 55%),
                  radial-gradient(900px 700px at 50% 90%, #0b0a1c 0%, #07040a 65%);
      color: var(--text);
      overflow:hidden;
    }

    /* fundo com “partículas” */
    .stars{
      position:fixed; inset:0; pointer-events:none; opacity:.35;
      background-image:
        radial-gradient(2px 2px at 10% 20%, #ffffffaa 50%, transparent 51%),
        radial-gradient(1px 1px at 40% 80%, #ffd1e0aa 50%, transparent 51%),
        radial-gradient(2px 2px at 70% 30%, #d9c8ffaa 50%, transparent 51%),
        radial-gradient(1px 1px at 85% 65%, #ffffffaa 50%, transparent 51%),
        radial-gradient(2px 2px at 25% 55%, #ff7aa3aa 50%, transparent 51%),
        radial-gradient(1px 1px at 55% 35%, #ffffffaa 50%, transparent 51%);
      animation: float 8s ease-in-out infinite alternate;
    }
    @keyframes float { from{transform:translateY(0)} to{transform:translateY(-10px)} }

    .app{height:100%; display:flex; flex-direction:column;}
    header{
      padding: 14px 16px 10px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, #ff3b6b, #8a2be2);
      box-shadow: 0 10px 30px rgba(255,59,107,.25);
      position:relative;
    }
    .logo:after{
      content:"❤";
      position:absolute; inset:0; display:grid; place-items:center;
      font-size:18px; filter:drop-shadow(0 6px 14px rgba(0,0,0,.45));
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.3px;}
    .brand p{margin:0; font-size:12px; color:var(--muted);}
    .pill{
      font-size:12px; padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }

    main{flex:1; position:relative;}
    #map{
      position:absolute; inset:0;
      background: #0b0710;
      display:none;
    }

    .screen{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      padding:18px 16px 22px;
      gap:14px;
    }
    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .hero{
      margin-top:6px;
      display:flex; flex-direction:column; gap:10px;
      align-items:flex-start;
    }
    .hero h2{margin:0; font-size:20px; line-height:1.15;}
    .hero p{margin:0; font-size:13px; color:var(--muted); line-height:1.45;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap;}
    button{
      appearance:none; border:none; cursor:pointer;
      padding:12px 14px; border-radius: 16px;
      color: var(--text);
      font-weight:700; letter-spacing:.2px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .2s ease, background .2s ease;
    }
    button:active{transform: scale(.98)}
    .primary{
      background: linear-gradient(135deg, #ff3b6b, #8a2be2);
      border: none;
    }
    .ok{ background: linear-gradient(135deg, #2ee59d, #19b3ff); border:none; }
    .danger{ background: linear-gradient(135deg, #ff3b6b, #ff1b3f); border:none; }
    .ghost{ background: rgba(255,255,255,.06); }
    .mini{ padding:10px 12px; font-size:12px; border-radius:14px; }

    .list{display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:12px; border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .item strong{font-size:13px;}
    .item small{display:block; font-size:11px; color:var(--muted); margin-top:3px;}

    /* HUD em cima do mapa */
    .hud{
      position:absolute; left:12px; right:12px; top:12px;
      display:none;
      gap:10px;
      z-index:10;
    }
    .hud .card{padding:12px; border-radius:18px;}
    .hudtop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .hudtitle{font-size:12px; color:var(--muted); margin:0;}
    .hudmode{font-size:14px; margin:2px 0 0; font-weight:800;}
    .hudactions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    /* Coração no meio quando coleta */
    .heartOverlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center; justify-content:center;
      z-index: 9999;

      background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
    }

    .heartWrap{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    .heartText{
      color: #eee;
      font-size: 14px;
      letter-spacing: .5px;
      text-shadow: 0 0 25px rgba(255,0,40,.35);
    }

    .heartStage{
      position: relative;
      width: min(380px, 86vw);
      height: min(380px, 86vw);
    }

    /* O CORAÇÃO */
    .heartGothic{
      position:absolute;
      inset:0;
      background-image: url("assets/heart-gothic.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;

      /* MÁSCARA QUE REVELA POR PARTES */
      -webkit-mask-image: linear-gradient(#000 0 0);
      -webkit-mask-size: 100% var(--mask-size, 0%);
      -webkit-mask-repeat: no-repeat;
      -webkit-mask-position: bottom;

      mask-image: linear-gradient(#000 0 0);
      mask-size: 100% var(--mask-size, 0%);
      mask-repeat: no-repeat;
      mask-position: bottom;

      filter:
        drop-shadow(0 0 35px rgba(0,0,0,.8))
        drop-shadow(0 0 25px rgba(255,0,40,.25));

      animation: heartIdle 1.1s ease-in-out infinite;
      transition: mask-size .35s ease, -webkit-mask-size .35s ease;
    }

    /* Palpitação constante */
    @keyframes heartIdle{
      0%   { transform: scale(.92); }
      50%  { transform: scale(1.02); }
      100% { transform: scale(.92); }
    }

    /* TUM forte ao coletar */
    .heartGothic.thump{
      animation: heartThump .35s ease-out 1, heartIdle 1.1s ease-in-out infinite;
    }

    @keyframes heartThump{
      0%   { transform: scale(.85); }
      60%  { transform: scale(1.08); }
      100% { transform: scale(1.02); }
    }

    /* SVG em cima do coração */
    .stitchSvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      filter: drop-shadow(0 0 12px rgba(255,0,40,.18));
    }

    /* O caminho da costura */
    #stitchPath{
      fill:none;
      stroke: rgba(230, 230, 230, .95);      /* cor da costura */
      stroke-width: 1.4;
      stroke-linecap: round;
      stroke-dasharray: 2.2 3.6;             /* pontilhado (costura) */
      opacity: .0;                            /* começa invisível */
    }

    /* bolinha final */
    #stitchDot{
      fill: rgba(255, 30, 70, .85);
      opacity: 0;
    }

    /* quando estiver costurando, aparece */
    .stitchOn #stitchPath{ opacity: .95; }
    .stitchOn #stitchDot{ opacity: .9; }

    /* efeito final: “fechou a rachadura” */
    .stitchComplete #stitchPath{
      stroke: rgba(255, 240, 245, .98);
      filter: drop-shadow(0 0 18px rgba(255,0,40,.35));
    }

    .toast{
      position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
      z-index:30; display:none;
      padding:10px 12px; border-radius:999px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      font-size:12px;
      max-width: 92vw;
      text-align:center;
    }

    /* ícone “gota de sangue” para marcador */
    .drop{
      width:16px; height:16px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 40%),
                  linear-gradient(135deg, #ff1b3f, #b2002f);
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      box-shadow: 0 10px 20px rgba(255,27,63,.25);
      border:1px solid rgba(255,255,255,.18);
    }
    .dropLabel{
      background: rgba(0,0,0,.65);
      color:#fff; font-weight:900; font-size:11px;
      padding:3px 7px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      transform: translateY(-8px);
    }

    .footerNote{font-size:12px; color:var(--muted); margin:0; line-height:1.35;}
    a{color:#ffd1e0}

    /* Modal da Carta Final */
    .finalLetterOverlay{
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }

    .finalLetterCard{
      width: min(420px, 92vw);
      border-radius: 24px;
      background: rgba(18,8,23,.94);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 60px rgba(0,0,0,.65);
      padding: 18px;
    }

    .finalTitle{
      margin:0;
      font-size: 18px;
      letter-spacing:.3px;
    }

    .finalSub{
      margin:6px 0 12px;
      font-size: 13px;
      color: rgba(255,255,255,.75);
    }

    .finalBody{
      font-size: 14px;
      line-height: 1.55;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px;
      max-height: 52vh;
      overflow:auto;
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <div class="app">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Curando Coração Partido</h1>
          <p>Mini game na vida real • GPS + Cartinhas</p>
        </div>
      </div>
      <div class="pill" id="gpsStatus">GPS: aguardando…</div>
    </header>

    <main>
      <div id="map"></div>

      <!-- HUD do mapa -->
      <div class="hud" id="hud">
        <div class="card" style="flex:1">
          <div class="hudtop">
            <div>
              <p class="hudtitle" id="hudSub">—</p>
              <div class="hudmode" id="hudTitle">—</div>
            </div>
            <div class="hudactions" id="hudActions"></div>
          </div>
        </div>
      </div>

      <!-- Tela inicial -->
      <section class="screen" id="homeScreen">
        <div class="card hero">
          <h2>Antes do mapa… um botão. <br/>Depois… um coração se curando.</h2>
          <p>
            Você cria um “jogo” marcando onde escondeu as cartinhas.
            Quem jogar vê pingos vermelhos no mapa e coleta cada parte do coração ao encontrar.
          </p>
          <div class="btnrow">
            <button class="primary" id="btnStart">Curando Coração Partido</button>
            <button class="ghost" id="btnHow">Como funciona</button>
          </div>
        </div>

        <div class="card">
          <div class="btnrow">
            <button class="ok" id="btnCreate">Criar jogo</button>
            <button class="primary" id="btnPlay">Jogar</button>
          </div>
          <p class="footerNote">
            Dica: no celular, ative a localização e use no Chrome/Edge. Precisa estar em HTTPS.
          </p>
        </div>

        <div class="card">
          <strong style="font-size:13px;">Jogos salvos neste celular</strong>
          <div class="list" id="gamesList" style="margin-top:10px;"></div>
          <p class="footerNote" style="margin-top:10px;">
            Se quiser enviar pra outra pessoa (outro celular), eu te ensino a gerar um <b>código/link</b>.
          </p>
        </div>
      </section>

      <!-- Modal “como funciona” -->
      <section class="screen" id="howScreen" style="display:none;">
        <div class="card">
          <h2 style="margin:0 0 10px; font-size:18px;">Como funciona</h2>
          <p class="footerNote">
            <b>Criar:</b> você anda e aperta <b>Marcar carta</b> em cada esconderijo. Ele numera 1…N.<br/><br/>
            <b>Jogar:</b> a pessoa escolhe o jogo, anda até os pingos vermelhos e quando estiver perto, aparece <b>Coletar</b>.
            A cada coleta o coração “se cura”.<br/><br/>
            <b>Distância:</b> o botão coletar aparece quando você estiver perto (ex.: 25m). Dá pra ajustar.
          </p>
          <div class="btnrow" style="margin-top:12px;">
            <button class="primary" id="btnBackHome1">Voltar</button>
          </div>
        </div>
      </section>

      <!-- Coração overlay -->
      <div class="heartOverlay" id="heartOverlay">
        <div class="heartWrap">
          <div class="heartStage">
            <div class="heartGothic" id="heartGothic"></div>

            <!-- COSTURA por cima -->
            <svg class="stitchSvg" viewBox="0 0 100 100" aria-hidden="true">
              <!-- linha principal (pontilhada) -->
              <path id="stitchPath"
                d="M50 8
                   C47 16, 46 22, 49 30
                   C52 38, 45 45, 49 54
                   C53 62, 46 68, 51 76
                   C56 84, 53 92, 50 98"
                />
              <!-- “agulha”/ponto final (opcional) -->
              <circle id="stitchDot" cx="50" cy="98" r="1.6"/>
            </svg>
          </div>

          <div class="heartText" id="progressText">Coração se curando…</div>
        </div>
      </div>

      <!-- Modal Carta Final -->
      <div class="finalLetterOverlay" id="finalLetterOverlay" style="display:none;">
        <div class="finalLetterCard">
          <h2 class="finalTitle">A última carta</h2>
          <p class="finalSub">Você juntou todas as partes… agora lê com calma.</p>

          <div class="finalBody" id="finalLetterBody">
            <!-- você troca esse texto pelo seu -->
            <p>Karine… eu não quero só consertar o coração. Eu quero cuidar dele com você.</p>
            <p>Se você topa, eu começo hoje — do jeito certo.</p>
            <p><b>— Junior</b></p>
          </div>

          <div class="btnrow" style="justify-content:flex-end; margin-top:14px;">
            <button class="primary" id="btnCloseFinal">Fechar</button>
          </div>
        </div>
      </div>

      <div class="toast" id="toast">—</div>
    </main>
  </div>

  <script>
    /***************
     * CONFIG
     ***************/
    const DEFAULT_COLLECT_RADIUS_METERS = 25; // distância pra aparecer “Coletar”
    const STORAGE_KEY = "hearts_maps_games_v1";

    /***************
     * STATE
     ***************/
    let map, userMarker, watchId = null;
    let currentPos = null;

    let mode = "home"; // "create" | "play" | "home"
    let createDraft = null; // { id, name, createdAt, points:[{lat,lng,idx}] }
    let activeGame = null;  // game selecionado pra jogar
    let pointMarkers = [];  // markers do jogo atual

    /***************
     * UI refs
     ***************/
    const gpsStatus = document.getElementById("gpsStatus");
    const homeScreen = document.getElementById("homeScreen");
    const howScreen = document.getElementById("howScreen");
    const mapEl = document.getElementById("map");
    const hud = document.getElementById("hud");
    const hudTitle = document.getElementById("hudTitle");
    const hudSub = document.getElementById("hudSub");
    const hudActions = document.getElementById("hudActions");
    const gamesList = document.getElementById("gamesList");

    const heartOverlay = document.getElementById("heartOverlay");
    const progressText = document.getElementById("progressText");
    // const progressFill = document.getElementById("progressFill");
    const toastEl = document.getElementById("toast");
    const finalLetterOverlay = document.getElementById("finalLetterOverlay");

    /***************
     * Helpers
     ***************/
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 2600);
    }

    function loadGames(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      }catch(e){
        return [];
      }
    }
    function saveGames(games){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(games));
    }

    function distanceMeters(a, b){
      // Haversine
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(x));
    }

    function setScreen(which){
      // which: "home" | "how" | "map"
      homeScreen.style.display = (which === "home") ? "flex" : "none";
      howScreen.style.display = (which === "how") ? "flex" : "none";
      mapEl.style.display = (which === "map") ? "block" : "none";
      hud.style.display = (which === "map") ? "flex" : "none";
    }

    function renderGamesList(){
      const games = loadGames();
      gamesList.innerHTML = "";
      if(!games.length){
        gamesList.innerHTML = `<div class="item"><div><strong>Nenhum jogo ainda</strong><small>Crie um jogo e ele fica salvo aqui.</small></div></div>`;
        return;
      }

      games.slice().reverse().forEach(g => {
        const el = document.createElement("div");
        const pts = g.points?.length || 0;
        const date = new Date(g.createdAt).toLocaleString();
        el.className = "item";
        el.innerHTML = `
          <div>
            <strong>${escapeHtml(g.name || "Jogo sem nome")}</strong>
            <small>${pts} carta(s) • criado em ${escapeHtml(date)}</small>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="mini primary" data-action="play" data-id="${g.id}">Jogar</button>
            <button class="mini ghost" data-action="delete" data-id="${g.id}">Apagar</button>
          </div>
        `;
        gamesList.appendChild(el);
      });

      gamesList.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          if(action === "delete"){
            const games = loadGames().filter(x => x.id !== id);
            saveGames(games);
            renderGamesList();
            toast("Jogo apagado.");
          }
          if(action === "play"){
            const g = loadGames().find(x => x.id === id);
            if(!g) return toast("Não achei esse jogo.");
            startPlay(g);
          }
        });
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    /***************
     * Map markers (blood drops)
     ***************/
    function makeDropMarker(position, labelText){
      const container = document.createElement("div");
      container.style.display = "grid";
      container.style.placeItems = "center";
      container.style.gap = "4px";

      const label = document.createElement("div");
      label.className = "dropLabel";
      label.textContent = labelText;

      const drop = document.createElement("div");
      drop.className = "drop";

      container.appendChild(label);
      container.appendChild(drop);

      return new google.maps.marker.AdvancedMarkerElement({
        map,
        position,
        content: container
      });
    }

    function clearPointMarkers(){
      pointMarkers.forEach(m => m.map = null);
      pointMarkers = [];
    }

    /***************
     * GPS / Watch position
     ***************/
    async function ensureGeolocation(){
      if(!("geolocation" in navigator)){
        gpsStatus.textContent = "GPS: indisponível";
        throw new Error("Sem geolocalização no navegador.");
      }

      gpsStatus.textContent = "GPS: pedindo permissão…";

      return new Promise((resolve, reject)=>{
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            gpsStatus.textContent = "GPS: ok";
            resolve(currentPos);
          },
          (err)=>{
            gpsStatus.textContent = "GPS: negado";
            reject(err);
          },
          { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
        );
      });
    }

    function startWatch(){
      if(watchId) return;
      watchId = navigator.geolocation.watchPosition(
        (pos)=>{
          currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          gpsStatus.textContent = "GPS: ok";
          if(map){
            userMarker.position = currentPos;
          }
          if(mode === "play" && activeGame){
            updateCollectButton();
          }
        },
        (err)=>{
          gpsStatus.textContent = "GPS: erro";
          console.warn(err);
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge:500 }
      );
    }
    function stopWatch(){
      if(!watchId) return;
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    /***************
     * Modes
     ***************/
    async function initMapIfNeeded(){
      if(map) return;

      await ensureGeolocation();

      map = new google.maps.Map(document.getElementById("map"), {
        center: currentPos,
        zoom: 18,
        mapId: "DEMO_MAP_ID",
        disableDefaultUI: true,
        zoomControl: true,
        gestureHandling: "greedy"
      });

      // marcador do usuário (bolinha azul)
      userMarker = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: currentPos,
        content: (() => {
          const dot = document.createElement("div");
          dot.style.width = "16px";
          dot.style.height = "16px";
          dot.style.borderRadius = "999px";
          dot.style.background = "radial-gradient(circle at 35% 35%, rgba(255,255,255,.55), transparent 45%), #3aa0ff";
          dot.style.border = "2px solid rgba(255,255,255,.85)";
          dot.style.boxShadow = "0 12px 28px rgba(58,160,255,.28)";
          return dot;
        })()
      });

      startWatch();
    }

    function setHud(title, sub, actionsHtml){
      hudTitle.textContent = title;
      hudSub.textContent = sub;
      hudActions.innerHTML = actionsHtml;
      // depois que inserir botões, liga eventos
      hudActions.querySelectorAll("button").forEach(btn=>{
        const a = btn.getAttribute("data-a");
        if(a === "back") btn.onclick = () => goHome();
        if(a === "mark") btn.onclick = () => markPoint();
        if(a === "finish") btn.onclick = () => finishCreate();
        if(a === "collect") btn.onclick = () => collectNearest();
        if(a === "recenter") btn.onclick = () => recenter();
        if(a === "reset") btn.onclick = () => resetProgress();
      });
    }

    function recenter(){
      if(map && currentPos){
        map.panTo(currentPos);
        map.setZoom(18);
      }
    }

    function goHome(){
      mode = "home";
      activeGame = null;
      createDraft = null;
      clearPointMarkers();
      setScreen("home");
      renderGamesList();
      toast("Voltou pro início.");
    }

    async function startCreate(){
      mode = "create";
      createDraft = {
        id: uid(),
        name: `Jogo ${new Date().toLocaleDateString()}`,
        createdAt: Date.now(),
        points: []
      };

      setScreen("map");
      await initMapIfNeeded();
      map.panTo(currentPos);
      clearPointMarkers();

      setHud(
        "Modo Criar",
        "Ande até o esconderijo e toque em “Marcar carta”.",
        `
          <button class="mini ghost" data-a="recenter">Centralizar</button>
          <button class="mini ok" data-a="mark">Marcar carta</button>
          <button class="mini primary" data-a="finish">Salvar jogo</button>
          <button class="mini ghost" data-a="back">Sair</button>
        `
      );

      toast("Criando: ande e marque cada cartinha.");
    }

    function markPoint(){
      if(!currentPos) return toast("Ainda sem GPS.");
      const idx = createDraft.points.length + 1;
      createDraft.points.push({ lat: currentPos.lat, lng: currentPos.lng, idx });

      const marker = makeDropMarker(currentPos, String(idx));
      pointMarkers.push(marker);

      toast(`Carta ${idx} marcada.`);
    }

    function finishCreate(){
      if(!createDraft.points.length){
        return toast("Marque pelo menos 1 carta antes de salvar.");
      }

      const name = prompt("Nome do jogo (ex.: 'Cartas da Karine'):", createDraft.name) || createDraft.name;
      createDraft.name = name.trim().slice(0, 40) || createDraft.name;

      const games = loadGames();
      games.push({
        ...createDraft,
        collected: {} // não usado no criar
      });
      saveGames(games);

      toast("Jogo salvo!");
      goHome();
    }

    async function startPlay(game){
      mode = "play";
      activeGame = JSON.parse(JSON.stringify(game)); // clone
      activeGame.collected = activeGame.collected || {};
      setScreen("map");
      await initMapIfNeeded();

      clearPointMarkers();
      map.panTo(currentPos);

      // desenha pontos
      activeGame.points.forEach(p=>{
        const marker = makeDropMarker({lat:p.lat, lng:p.lng}, String(p.idx));
        pointMarkers.push(marker);
      });

      setHud(
        "Modo Jogar",
        `${activeGame.name} • chegue perto de um pingo e colete.`,
        `
          <button class="mini ghost" data-a="recenter">Centralizar</button>
          <button class="mini primary" data-a="collect" id="collectBtn" disabled>Coletar</button>
          <button class="mini ghost" data-a="reset">Resetar progresso</button>
          <button class="mini ghost" data-a="back">Sair</button>
        `
      );

      updateCollectButton();
      toast("Vá até uma marca vermelha. Quando estiver perto, colete.");
    }

    function resetProgress(){
      if(!activeGame) return;
      activeGame.collected = {};
      toast("Progresso resetado neste jogo (sessão atual).");
      updateCollectButton();
    }

    function updateCollectButton(){
      const btn = document.getElementById("collectBtn");
      if(!btn || !activeGame || !currentPos) return;

      const nearest = findNearestUncollected();
      if(!nearest){
        btn.disabled = true;
        btn.textContent = "Coletar";
        return;
      }

      const d = nearest.dist;
      if(d <= DEFAULT_COLLECT_RADIUS_METERS){
        btn.disabled = false;
        btn.textContent = `Coletar #${nearest.point.idx}`;
      }else{
        btn.disabled = true;
        btn.textContent = `Chegue mais perto (${Math.round(d)}m)`;
      }
    }

    function findNearestUncollected(){
      const pts = activeGame.points.filter(p => !activeGame.collected[p.idx]);
      if(!pts.length) return null;

      let best = null;
      for(const p of pts){
        const d = distanceMeters(currentPos, {lat:p.lat, lng:p.lng});
        if(!best || d < best.dist) best = { point:p, dist:d };
      }
      return best;
    }

    function collectNearest(){
      if(!activeGame || !currentPos) return;
      const nearest = findNearestUncollected();
      if(!nearest) return toast("Você já coletou tudo! ❤");

      if(nearest.dist > DEFAULT_COLLECT_RADIUS_METERS){
        return toast(`Ainda falta chegar mais perto (≈ ${Math.round(nearest.dist)}m).`);
      }

      const idx = nearest.point.idx;
      activeGame.collected[idx] = true;

      // anima coração
      showHeartProgress();

      // feedback
      navigator.vibrate?.([60, 40, 60]); // vibra se suportar
      toast(`Coletado! Carta #${idx}.`);

      updateCollectButton();

      // se terminou tudo
      if(Object.keys(activeGame.collected).length === activeGame.points.length){
        setTimeout(()=> toast("Coração completo. Agora é só ler todas as cartinhas ❤"), 300);

        // dá 1 seg pra ver o coração completo + costura final
        setTimeout(() => {
          finalLetterOverlay.style.display = "flex";
        }, 900);
      }
    }

    function showHeartProgress(){
      const total = activeGame.points.length;               // total de cartas
      const got   = Object.keys(activeGame.collected).length;

      const pct = Math.max(0, Math.min(1, got / total));
      const maskPct = Math.round(pct * 100) + "%";

      const heart = document.getElementById("heartGothic");
      const text  = document.getElementById("progressText");

      heartOverlay.style.display = "flex";
      text.textContent = `Coração se curando… ${got}/${total}`;

      // Revela MAIS UM PEDAÇO REAL
      heart.style.setProperty("--mask-size", maskPct);

      // Atualiza costura
      setStitchProgress(pct);

      // Efeito final da costura
      if (got === total) {
        document.querySelector(".stitchSvg")?.classList.add("stitchComplete");
      }

      // anima “TUM”
      heart.classList.remove("thump");
      void heart.offsetWidth;
      heart.classList.add("thump");
      setTimeout(() => heart.classList.remove("thump"), 350);

      // áudio + vibração
      navigator.vibrate?.([50, 30, 50]);
      if(typeof heartBeatSound === "function") heartBeatSound();
    }

    function setStitchProgress(pct01){
      const svg = document.querySelector(".stitchSvg");
      const path = document.getElementById("stitchPath");
      if (!svg || !path) return;

      // ativa visual
      svg.classList.add("stitchOn");

      // prepara dash para revelar do começo ao fim
      const len = path.getTotalLength();
      path.style.strokeDasharray = `${len}`;
      path.style.strokeDashoffset = `${len}`;

      // revela de acordo com pct
      const offset = len * (1 - pct01);
      path.style.strokeDashoffset = `${offset}`;
    }

    // Fecha overlay ao clicar
    heartOverlay.onclick = () => {
      heartOverlay.style.display = "none";
    };

    document.getElementById("btnCloseFinal")?.addEventListener("click", ()=>{
      finalLetterOverlay.style.display = "none";
    });

    /***************
     * Home actions
     ***************/
    document.getElementById("btnStart").onclick = async () => {
      toast("Abrindo o mapa…");
      // só entra no mapa (não decide modo ainda)
      await initMapIfNeeded().catch(()=>{});
      toast("Escolha: Criar ou Jogar.");
    };

    document.getElementById("btnCreate").onclick = () => startCreate();
    document.getElementById("btnPlay").onclick = () => {
      const games = loadGames();
      if(!games.length){
        toast("Você ainda não criou nenhum jogo.");
        return;
      }
      // abre lista, mas já tem na home. Só dá uma dica.
      toast("Escolha um jogo na lista e toque em Jogar.");
      window.scrollTo?.(0, 999999);
    };

    document.getElementById("btnHow").onclick = () => setScreen("how");
    document.getElementById("btnBackHome1").onclick = () => setScreen("home");

    /***************
     * Boot
     ***************/
    function boot(){
      setScreen("home");
      renderGamesList();
      // tenta GPS silencioso pra já mostrar status
      if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          ()=> gpsStatus.textContent = "GPS: ok",
          ()=> gpsStatus.textContent = "GPS: toque e permita",
          { enableHighAccuracy:true, timeout:6000, maximumAge:2000 }
        );
      } else {
        gpsStatus.textContent = "GPS: indisponível";
      }
    }

    boot();
  </script>

  <!-- Google Maps JS + Advanced Markers -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARASuT7Un6A0o7DIMsknY7RsrXTgZLYbI&v=weekly&libraries=marker">
  </script>

    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBCAYGY53ct_hoqaD_2nk38MJMlVrEtnIQ",
  authDomain: "coracaopartido-19da0.firebaseapp.com",
  projectId: "coracaopartido-19da0",
  storageBucket: "coracaopartido-19da0.firebasestorage.app",
  messagingSenderId: "1037104075180",
  appId: "1:1037104075180:web:be6adbdb478ca8dbab2a09",
  measurementId: "G-TPHK9H5747"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

</body>
</html>
